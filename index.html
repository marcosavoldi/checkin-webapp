<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in Casa Vacanze</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-blue {
            background: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%);
        }
        .gradient-green {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
        }
        .gradient-orange {
            background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
        }
        .gradient-pink {
            background: linear-gradient(135deg, #E91E63 0%, #9C27B0 100%);
        }
        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 min-h-screen">
    <div id="root"></div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, where, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Import configuration
        import { firebaseConfig } from './firebase-config.js';
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make available globally for React components
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.Timestamp = Timestamp;
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Translations
        const translations = {
            it: {
                login: 'Accedi con Google',
                logout: 'Esci',
                dashboard: 'Dashboard Amministratore',
                myProperties: 'Le mie strutture',
                addProperty: 'Aggiungi Struttura',
                propertyName: 'Nome Struttura',
                createBooking: 'Crea Prenotazione',
                guestName: 'Nome Ospite',
                checkIn: 'Check-in',
                checkOut: 'Check-out',
                generateLink: 'Genera Link',
                bookingLink: 'Link Prenotazione',
                copyLink: 'Copia Link',
                recentBookings: 'Prenotazioni Recenti',
                guestForm: 'Dati Ospite',
                documentData: 'Dati Documento',
                documentNumber: 'Numero Documento',
                issueDate: 'Data Rilascio',
                expiryDate: 'Data Scadenza',
                issuePlace: 'Luogo Rilascio',
                personalData: 'Dati Anagrafici',
                firstName: 'Nome',
                lastName: 'Cognome',
                address: 'Indirizzo Completo',
                nationality: 'Nazionalit√†',
                phone: 'Telefono',
                bookingDates: 'Date Prenotazione',
                submit: 'Invia Dati',
                submitting: 'Invio in corso...',
                success: 'Dati inviati con successo!',
                error: 'Errore durante l\'invio',
                required: 'Campo obbligatorio',
                invalidDate: 'Data non valida',
                invalidPhone: 'Numero di telefono non valido',
                bookingNotFound: 'Prenotazione non trovata',
                loading: 'Caricamento...',
                deleteProperty: 'Elimina Struttura',
                deleteBooking: 'Elimina Prenotazione',
                confirmDelete: 'Sei sicuro di voler eliminare?',
                checkInInstructions: 'Istruzioni Check-in',
                instructionsHelp: 'Le istruzioni verranno inviate all\'ospite nella lingua da lui selezionata',
                selectLanguage: 'Seleziona la tua lingua',
                emailWillReceive: 'Riceverai le istruzioni a questo indirizzo nella lingua selezionata'
            },
            en: {
                login: 'Login with Google',
                logout: 'Logout',
                dashboard: 'Admin Dashboard',
                myProperties: 'My Properties',
                addProperty: 'Add Property',
                propertyName: 'Property Name',
                createBooking: 'Create Booking',
                guestName: 'Guest Name',
                checkIn: 'Check-in',
                checkOut: 'Check-out',
                generateLink: 'Generate Link',
                bookingLink: 'Booking Link',
                copyLink: 'Copy Link',
                recentBookings: 'Recent Bookings',
                guestForm: 'Guest Information',
                documentData: 'Document Data',
                documentNumber: 'Document Number',
                issueDate: 'Issue Date',
                expiryDate: 'Expiry Date',
                issuePlace: 'Issue Place',
                personalData: 'Personal Data',
                firstName: 'First Name',
                lastName: 'Last Name',
                address: 'Full Address',
                nationality: 'Nationality',
                phone: 'Phone',
                bookingDates: 'Booking Dates',
                submit: 'Submit',
                submitting: 'Submitting...',
                success: 'Data sent successfully!',
                error: 'Error sending data',
                required: 'Required field',
                invalidDate: 'Invalid date',
                invalidPhone: 'Invalid phone number',
                bookingNotFound: 'Booking not found',
                loading: 'Loading...',
                deleteProperty: 'Delete Property',
                deleteBooking: 'Delete Booking',
                confirmDelete: 'Are you sure you want to delete?',
                checkInInstructions: 'Check-in Instructions',
                instructionsHelp: 'Instructions will be sent to the guest in their selected language',
                selectLanguage: 'Select your language',
                emailWillReceive: 'You will receive instructions at this address in the selected language'
            },
            fr: {
                login: 'Connexion avec Google',
                logout: 'D√©connexion',
                dashboard: 'Tableau de bord Admin',
                myProperties: 'Mes Propri√©t√©s',
                addProperty: 'Ajouter Propri√©t√©',
                propertyName: 'Nom de la Propri√©t√©',
                createBooking: 'Cr√©er R√©servation',
                guestName: 'Nom de l\'Invit√©',
                checkIn: 'Arriv√©e',
                checkOut: 'D√©part',
                generateLink: 'G√©n√©rer Lien',
                bookingLink: 'Lien R√©servation',
                copyLink: 'Copier Lien',
                recentBookings: 'R√©servations R√©centes',
                guestForm: 'Donn√©es Invit√©',
                documentData: 'Donn√©es Document',
                documentNumber: 'Num√©ro Document',
                issueDate: 'Date d\'√âmission',
                expiryDate: 'Date d\'Expiration',
                issuePlace: 'Lieu d\'√âmission',
                personalData: 'Donn√©es Personnelles',
                firstName: 'Pr√©nom',
                lastName: 'Nom',
                address: 'Adresse Compl√®te',
                nationality: 'Nationalit√©',
                phone: 'T√©l√©phone',
                bookingDates: 'Dates R√©servation',
                submit: 'Envoyer',
                submitting: 'Envoi en cours...',
                success: 'Donn√©es envoy√©es avec succ√®s!',
                error: 'Erreur lors de l\'envoi',
                required: 'Champ obligatoire',
                invalidDate: 'Date invalide',
                invalidPhone: 'Num√©ro de t√©l√©phone invalide',
                bookingNotFound: 'R√©servation non trouv√©e',
                loading: 'Chargement...',
                deleteProperty: 'Supprimer Propri√©t√©',
                deleteBooking: 'Supprimer R√©servation',
                confirmDelete: '√ätes-vous s√ªr de vouloir supprimer?',
                checkInInstructions: 'Instructions d\'Arriv√©e',
                instructionsHelp: 'Les instructions seront envoy√©es √† l\'invit√© dans la langue s√©lectionn√©e',
                selectLanguage: 'S√©lectionnez votre langue',
                emailWillReceive: 'Vous recevrez les instructions √† cette adresse dans la langue s√©lectionn√©e'
            },
            de: {
                login: 'Mit Google anmelden',
                logout: 'Abmelden',
                dashboard: 'Admin Dashboard',
                myProperties: 'Meine Unterk√ºnfte',
                addProperty: 'Unterkunft Hinzuf√ºgen',
                propertyName: 'Name der Unterkunft',
                createBooking: 'Buchung Erstellen',
                guestName: 'Gastname',
                checkIn: 'Check-in',
                checkOut: 'Check-out',
                generateLink: 'Link Generieren',
                bookingLink: 'Buchungslink',
                copyLink: 'Link Kopieren',
                recentBookings: 'Letzte Buchungen',
                guestForm: 'Gastdaten',
                documentData: 'Dokumentdaten',
                documentNumber: 'Dokumentnummer',
                issueDate: 'Ausstellungsdatum',
                expiryDate: 'Ablaufdatum',
                issuePlace: 'Ausstellungsort',
                personalData: 'Pers√∂nliche Daten',
                firstName: 'Vorname',
                lastName: 'Nachname',
                address: 'Vollst√§ndige Adresse',
                nationality: 'Staatsangeh√∂rigkeit',
                phone: 'Telefon',
                bookingDates: 'Buchungsdaten',
                submit: 'Absenden',
                submitting: 'Wird gesendet...',
                success: 'Daten erfolgreich gesendet!',
                error: 'Fehler beim Senden',
                required: 'Pflichtfeld',
                invalidDate: 'Ung√ºltiges Datum',
                invalidPhone: 'Ung√ºltige Telefonnummer',
                bookingNotFound: 'Buchung nicht gefunden',
                loading: 'Laden...',
                deleteProperty: 'Unterkunft L√∂schen',
                deleteBooking: 'Buchung L√∂schen',
                confirmDelete: 'Sind Sie sicher, dass Sie l√∂schen m√∂chten?',
                checkInInstructions: 'Check-in Anweisungen',
                instructionsHelp: 'Anweisungen werden dem Gast in der ausgew√§hlten Sprache gesendet',
                selectLanguage: 'W√§hlen Sie Ihre Sprache',
                emailWillReceive: 'Sie erhalten Anweisungen an diese Adresse in der ausgew√§hlten Sprache'
            },
            es: {
                login: 'Iniciar sesi√≥n con Google',
                logout: 'Cerrar sesi√≥n',
                dashboard: 'Panel de Administraci√≥n',
                myProperties: 'Mis Propiedades',
                addProperty: 'A√±adir Propiedad',
                propertyName: 'Nombre de la Propiedad',
                createBooking: 'Crear Reserva',
                guestName: 'Nombre del Hu√©sped',
                checkIn: 'Check-in',
                checkOut: 'Check-out',
                generateLink: 'Generar Enlace',
                bookingLink: 'Enlace Reserva',
                copyLink: 'Copiar Enlace',
                recentBookings: 'Reservas Recientes',
                guestForm: 'Datos Hu√©sped',
                documentData: 'Datos Documento',
                documentNumber: 'N√∫mero Documento',
                issueDate: 'Fecha Emisi√≥n',
                expiryDate: 'Fecha Vencimiento',
                issuePlace: 'Lugar Emisi√≥n',
                personalData: 'Datos Personales',
                firstName: 'Nombre',
                lastName: 'Apellido',
                address: 'Direcci√≥n Completa',
                nationality: 'Nacionalidad',
                phone: 'Tel√©fono',
                bookingDates: 'Fechas Reserva',
                submit: 'Enviar',
                submitting: 'Enviando...',
                success: '¬°Datos enviados correctamente!',
                error: 'Error al enviar',
                required: 'Campo obligatorio',
                invalidDate: 'Fecha inv√°lida',
                invalidPhone: 'N√∫mero de tel√©fono inv√°lido',
                bookingNotFound: 'Reserva no encontrada',
                loading: 'Cargando...',
                deleteProperty: 'Eliminar Propiedad',
                deleteBooking: 'Eliminar Reserva',
                confirmDelete: '¬øEst√° seguro de que desea eliminar?',
                checkInInstructions: 'Instrucciones de Check-in',
                instructionsHelp: 'Las instrucciones se enviar√°n al hu√©sped en el idioma seleccionado',
                selectLanguage: 'Seleccione su idioma',
                emailWillReceive: 'Recibir√° instrucciones en esta direcci√≥n en el idioma seleccionado'
            }
        };

        // Language flags
        const languages = [
            { code: 'it', flag: 'üáÆüáπ', name: 'Italiano' },
            { code: 'en', flag: 'üá¨üáß', name: 'English' },
            { code: 'fr', flag: 'üá´üá∑', name: 'Fran√ßais' },
            { code: 'de', flag: 'üá©üá™', name: 'Deutsch' },
            { code: 'es', flag: 'üá™üá∏', name: 'Espa√±ol' }
        ];

        // Language Selector Component - UN SOLO COMPONENTE RIUTILIZZABILE
        function LanguageSelector({ currentLang, onLanguageChange, showLabel = false, t }) {
            return (
                <div className="flex flex-col items-center gap-2">
                    {showLabel && (
                        <label className="text-sm font-bold text-gray-700">{t.selectLanguage}</label>
                    )}
                    <div className="flex gap-3 justify-center">
                        {languages.map(lang => (
                            <button
                                key={lang.code}
                                onClick={() => onLanguageChange(lang.code)}
                                className={`text-3xl transition-all hover:scale-110 ${
                                    currentLang === lang.code ? 'scale-125 drop-shadow-lg' : 'opacity-50 grayscale'
                                }`}
                                title={lang.name}
                            >
                                {lang.flag}
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        // Login Page Component
        function LoginPage({ t }) {
            const [loading, setLoading] = useState(false);

            const handleLogin = async () => {
                setLoading(true);
                try {
                    const provider = new window.GoogleAuthProvider();
                    await window.signInWithPopup(window.firebaseAuth, provider);
                } catch (error) {
                    console.error('Login error:', error);
                    alert('Errore durante il login');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full card-hover">
                        <div className="gradient-bg text-white rounded-xl p-6 mb-6 text-center">
                            <h1 className="text-3xl font-bold mb-2">
                                üè† Check-in
                            </h1>
                            <p className="text-sm opacity-90">Casa Vacanze Management</p>
                        </div>
                        <button
                            onClick={handleLogin}
                            disabled={loading}
                            className="w-full gradient-blue text-white py-4 rounded-xl hover:shadow-lg transition-all disabled:opacity-50 flex items-center justify-center gap-3 font-semibold text-lg"
                        >
                            <svg className="w-6 h-6" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/>
                            </svg>
                            {loading ? t.loading : t.login}
                        </button>
                    </div>
                </div>
            );
        }

        // Admin Dashboard Component
        function AdminDashboard({ t, user, onLogout }) {
            const [properties, setProperties] = useState([]);
            const [selectedProperty, setSelectedProperty] = useState(null);
            const [showAddProperty, setShowAddProperty] = useState(false);
            const [newProperty, setNewProperty] = useState({
                name: '',
                instructions: {
                    it: '',
                    en: '',
                    fr: '',
                    de: '',
                    es: ''
                }
            });
            const [bookingForm, setBookingForm] = useState({
                guestName: '',
                checkIn: '',
                checkOut: ''
            });
            const [generatedLink, setGeneratedLink] = useState('');
            const [recentBookings, setRecentBookings] = useState([]);

            useEffect(() => {
                loadProperties();
                loadRecentBookings();
            }, []);

            const loadProperties = async () => {
                const q = window.query(
                    window.collection(window.firebaseDb, 'properties'),
                    window.where('ownerId', '==', user.uid)
                );
                const snapshot = await window.getDocs(q);
                const props = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setProperties(props);
            };

            const loadRecentBookings = async () => {
                const q = window.query(
                    window.collection(window.firebaseDb, 'bookings'),
                    window.where('ownerId', '==', user.uid),
                    window.orderBy('createdAt', 'desc')
                );
                const snapshot = await window.getDocs(q);
                const bookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setRecentBookings(bookings.slice(0, 10));
            };

            const addProperty = async (e) => {
                e.preventDefault();
                try {
                    await window.addDoc(window.collection(window.firebaseDb, 'properties'), {
                        name: newProperty.name,
                        checkInInstructions: newProperty.instructions,
                        ownerId: user.uid,
                        createdAt: window.Timestamp.now()
                    });
                    setNewProperty({
                        name: '',
                        instructions: {
                            it: '',
                            en: '',
                            fr: '',
                            de: '',
                            es: ''
                        }
                    });
                    setShowAddProperty(false);
                    loadProperties();
                    alert('‚úÖ Struttura aggiunta con successo!');
                } catch (error) {
                    console.error('Error adding property:', error);
                    alert('‚ùå Errore durante l\'aggiunta della struttura');
                }
            };

            const deleteProperty = async (propertyId) => {
                if (!window.confirm(t.confirmDelete)) return;
                
                try {
                    await window.deleteDoc(window.doc(window.firebaseDb, 'properties', propertyId));
                    if (selectedProperty?.id === propertyId) {
                        setSelectedProperty(null);
                    }
                    loadProperties();
                    alert('‚úÖ Struttura eliminata con successo!');
                } catch (error) {
                    console.error('Error deleting property:', error);
                    alert('‚ùå Errore durante l\'eliminazione');
                }
            };

            const deleteBooking = async (bookingId) => {
                if (!window.confirm(t.confirmDelete)) return;
                
                try {
                    await window.deleteDoc(window.doc(window.firebaseDb, 'bookings', bookingId));
                    loadRecentBookings();
                    alert('‚úÖ Prenotazione eliminata con successo!');
                } catch (error) {
                    console.error('Error deleting booking:', error);
                    alert('‚ùå Errore durante l\'eliminazione');
                }
            };

            const generateBookingLink = async (e) => {
                e.preventDefault();
                try {
                    const bookingRef = await window.addDoc(window.collection(window.firebaseDb, 'bookings'), {
                        propertyId: selectedProperty.id,
                        propertyName: selectedProperty.name,
                        guestName: bookingForm.guestName,
                        checkIn: bookingForm.checkIn,
                        checkOut: bookingForm.checkOut,
                        ownerId: user.uid,
                        ownerEmail: user.email,
                        status: 'pending',
                        createdAt: window.Timestamp.now()
                    });

                    const link = `${window.location.origin}${window.location.pathname}?booking=${bookingRef.id}`;
                    setGeneratedLink(link);
                    loadRecentBookings();
                } catch (error) {
                    console.error('Error creating booking:', error);
                    alert('Errore durante la creazione della prenotazione');
                }
            };

            const copyLink = () => {
                navigator.clipboard.writeText(generatedLink);
                alert('‚úÖ Link copiato!');
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    {/* Header con gradiente */}
                    <div className="gradient-bg text-white rounded-2xl shadow-xl p-6 mb-8">
                        <div className="flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-bold mb-2">{t.dashboard}</h1>
                                <p className="opacity-90">üëã Benvenuto, {user.displayName}</p>
                            </div>
                            <button
                                onClick={onLogout}
                                className="bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-xl transition-all backdrop-blur-sm"
                            >
                                {t.logout}
                            </button>
                        </div>
                    </div>

                    <div className="grid lg:grid-cols-2 gap-6">
                        {/* Properties Section */}
                        <div className="bg-white rounded-2xl shadow-lg p-6 card-hover">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-2xl font-bold text-purple-600">üè† {t.myProperties}</h2>
                                <button
                                    onClick={() => setShowAddProperty(!showAddProperty)}
                                    className="gradient-green text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all"
                                >
                                    {showAddProperty ? '‚úï' : '+ ' + t.addProperty}
                                </button>
                            </div>

                            {showAddProperty && (
                                <form onSubmit={addProperty} className="mb-6 bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-xl">
                                    <div className="mb-3">
                                        <label className="block text-sm font-bold mb-2 text-gray-700">üè† {t.propertyName}</label>
                                        <input
                                            type="text"
                                            value={newProperty.name}
                                            onChange={(e) => setNewProperty({...newProperty, name: e.target.value})}
                                            placeholder="Es: Villa Mare, Appartamento Centro..."
                                            className="w-full border-2 border-gray-200 rounded-lg px-4 py-2 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all"
                                            required
                                        />
                                    </div>
                                    
                                    <div className="mb-3">
                                        <label className="block text-sm font-bold mb-2 text-gray-700">
                                            üìã {t.checkInInstructions}
                                        </label>
                                        <p className="text-xs text-gray-600 mb-2">{t.instructionsHelp}</p>
                                        
                                        {/* Istruzioni multilingua */}
                                        {languages.map(lang => (
                                            <div key={lang.code} className="mb-3">
                                                <label className="block text-xs font-semibold mb-1 text-gray-600">
                                                    {lang.flag} {lang.name}
                                                </label>
                                                <textarea
                                                    value={newProperty.instructions[lang.code]}
                                                    onChange={(e) => setNewProperty({
                                                        ...newProperty,
                                                        instructions: {
                                                            ...newProperty.instructions,
                                                            [lang.code]: e.target.value
                                                        }
                                                    })}
                                                    placeholder={`Istruzioni in ${lang.name}...`}
                                                    className="w-full border-2 border-gray-200 rounded-lg px-3 py-2 h-20 text-sm focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all"
                                                    rows="2"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <button
                                        type="submit"
                                        className="w-full gradient-green text-white py-3 rounded-lg hover:shadow-lg transition-all font-semibold"
                                    >
                                        üíæ Salva Struttura
                                    </button>
                                </form>
                            )}

                            <div className="space-y-3 max-h-96 overflow-y-auto">
                                {properties.map(prop => (
                                    <div
                                        key={prop.id}
                                        className={`p-4 rounded-xl border-2 transition-all cursor-pointer ${
                                            selectedProperty?.id === prop.id
                                                ? 'border-purple-500 bg-purple-50 shadow-md'
                                                : 'border-gray-200 hover:border-purple-300 bg-white'
                                        }`}
                                    >
                                        <div className="flex justify-between items-start">
                                            <div 
                                                className="flex-1"
                                                onClick={() => setSelectedProperty(prop)}
                                            >
                                                <div className="font-bold text-lg text-gray-800">{prop.name}</div>
                                                {prop.checkInInstructions && prop.checkInInstructions.it && (
                                                    <div className="text-xs text-gray-500 mt-1 truncate">
                                                        üìã {prop.checkInInstructions.it.substring(0, 50)}...
                                                    </div>
                                                )}
                                            </div>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    deleteProperty(prop.id);
                                                }}
                                                className="ml-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm transition-all"
                                                title={t.deleteProperty}
                                            >
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                {properties.length === 0 && (
                                    <div className="text-center text-gray-400 py-8">
                                        Nessuna struttura. Aggiungi la prima! üè†
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Create Booking Section */}
                        <div className="bg-white rounded-2xl shadow-lg p-6 card-hover">
                            <h2 className="text-2xl font-bold mb-4 text-blue-600">üìÖ {t.createBooking}</h2>
                            {selectedProperty ? (
                                <form onSubmit={generateBookingLink} className="space-y-4">
                                    <div className="bg-blue-50 p-4 rounded-xl mb-4">
                                        <div className="text-sm text-gray-600">Struttura selezionata:</div>
                                        <div className="font-bold text-lg text-blue-600">{selectedProperty.name}</div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold mb-2">üë§ {t.guestName}</label>
                                        <input
                                            type="text"
                                            value={bookingForm.guestName}
                                            onChange={(e) => setBookingForm({...bookingForm, guestName: e.target.value})}
                                            className="w-full border-2 border-gray-200 rounded-lg px-4 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                                            required
                                        />
                                    </div>
                                    <div className="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">üìÖ {t.checkIn}</label>
                                            <input
                                                type="date"
                                                value={bookingForm.checkIn}
                                                onChange={(e) => setBookingForm({...bookingForm, checkIn: e.target.value})}
                                                className="w-full border-2 border-gray-200 rounded-lg px-4 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">üìÖ {t.checkOut}</label>
                                            <input
                                                type="date"
                                                value={bookingForm.checkOut}
                                                onChange={(e) => setBookingForm({...bookingForm, checkOut: e.target.value})}
                                                className="w-full border-2 border-gray-200 rounded-lg px-4 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                                                required
                                            />
                                        </div>
                                    </div>
                                    <button
                                        type="submit"
                                        className="w-full gradient-blue text-white py-4 rounded-xl hover:shadow-lg transition-all font-semibold text-lg"
                                    >
                                        üîó {t.generateLink}
                                    </button>
                                </form>
                            ) : (
                                <div className="text-center text-gray-400 py-12">
                                    <div className="text-6xl mb-4">üè†</div>
                                    <p>Seleziona una struttura per creare una prenotazione</p>
                                </div>
                            )}

                            {generatedLink && (
                                <div className="mt-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border-2 border-green-300">
                                    <p className="font-bold mb-2 text-green-700">‚úÖ {t.bookingLink}:</p>
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={generatedLink}
                                            readOnly
                                            className="flex-1 border-2 border-green-300 rounded-lg px-3 py-2 text-sm bg-white"
                                        />
                                        <button
                                            onClick={copyLink}
                                            className="gradient-green text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all font-semibold"
                                        >
                                            üìã {t.copyLink}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Recent Bookings */}
                    <div className="bg-white rounded-2xl shadow-lg p-6 mt-6 card-hover">
                        <h2 className="text-2xl font-bold mb-4 text-orange-600">üìä {t.recentBookings}</h2>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gradient-to-r from-orange-50 to-pink-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left font-bold text-gray-700">{t.propertyName}</th>
                                        <th className="px-4 py-3 text-left font-bold text-gray-700">{t.guestName}</th>
                                        <th className="px-4 py-3 text-left font-bold text-gray-700">{t.checkIn}</th>
                                        <th className="px-4 py-3 text-left font-bold text-gray-700">{t.checkOut}</th>
                                        <th className="px-4 py-3 text-left font-bold text-gray-700">Status</th>
                                        <th className="px-4 py-3 text-left font-bold text-gray-700">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {recentBookings.map(booking => (
                                        <tr key={booking.id} className="border-t border-gray-100 hover:bg-orange-50 transition-colors">
                                            <td className="px-4 py-3 font-medium">{booking.propertyName}</td>
                                            <td className="px-4 py-3">{booking.guestName}</td>
                                            <td className="px-4 py-3">{booking.checkIn}</td>
                                            <td className="px-4 py-3">{booking.checkOut}</td>
                                            <td className="px-4 py-3">
                                                <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                                    booking.status === 'completed' 
                                                        ? 'bg-green-100 text-green-700' 
                                                        : 'bg-yellow-100 text-yellow-700'
                                                }`}>
                                                    {booking.status === 'completed' ? '‚úÖ Completato' : '‚è≥ In attesa'}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3">
                                                <button
                                                    onClick={() => deleteBooking(booking.id)}
                                                    className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm transition-all"
                                                    title={t.deleteBooking}
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                    {recentBookings.length === 0 && (
                                        <tr>
                                            <td colSpan="6" className="text-center text-gray-400 py-8">
                                                Nessuna prenotazione ancora üìÖ
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        // Guest Form Component
        function GuestForm({ t, bookingId, language, onLanguageChange }) {
            const [booking, setBooking] = useState(null);
            const [property, setProperty] = useState(null);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [submitting, setSubmitting] = useState(false);
            const [submitted, setSubmitted] = useState(false);
            const [formData, setFormData] = useState({
                email: '',
                documentNumber: '',
                issueDate: '',
                expiryDate: '',
                issuePlace: '',
                firstName: '',
                lastName: '',
                address: '',
                nationality: '',
                phone: ''
            });
            const [errors, setErrors] = useState({});

            useEffect(() => {
                const unsubscribe = window.onAuthStateChanged(window.firebaseAuth, async (user) => {
                    setUser(user);
                    if (user && bookingId) {
                        await loadBookingData();
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [bookingId]);

            const loadBookingData = async () => {
                try {
                    const bookingDoc = await window.getDoc(window.doc(window.firebaseDb, 'bookings', bookingId));
                    if (bookingDoc.exists()) {
                        const bookingData = bookingDoc.data();
                        setBooking({ id: bookingDoc.id, ...bookingData });
                        
                        // Load property data
                        const propertyDoc = await window.getDoc(window.doc(window.firebaseDb, 'properties', bookingData.propertyId));
                        if (propertyDoc.exists()) {
                            setProperty(propertyDoc.data());
                        }
                    }
                } catch (error) {
                    console.error('Error loading booking:', error);
                }
            };

            const validateForm = () => {
                const newErrors = {};
                
                if (!formData.email || !/\S+@\S+\.\S+/.test(formData.email)) {
                    newErrors.email = t.required;
                }
                if (!formData.documentNumber) newErrors.documentNumber = t.required;
                if (!formData.issueDate) newErrors.issueDate = t.required;
                if (!formData.expiryDate) newErrors.expiryDate = t.required;
                if (!formData.issuePlace) newErrors.issuePlace = t.required;
                if (!formData.firstName) newErrors.firstName = t.required;
                if (!formData.lastName) newErrors.lastName = t.required;
                if (!formData.address) newErrors.address = t.required;
                if (!formData.nationality) newErrors.nationality = t.required;
                if (!formData.phone) newErrors.phone = t.required;

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!validateForm()) {
                    alert(t.error);
                    return;
                }

                setSubmitting(true);
                
                console.log('üîç DEBUG - Inizio invio form');
                console.log('üìß Email ospite:', formData.email);
                console.log('üåç Lingua selezionata:', language);
                console.log('üìã Booking ID:', bookingId);
                
                try {
                    // CRITICAL: Save guest data with ALL required fields
                    const guestDataToSave = {
                        // Form data
                        email: formData.email,
                        documentNumber: formData.documentNumber,
                        issueDate: formData.issueDate,
                        expiryDate: formData.expiryDate,
                        issuePlace: formData.issuePlace,
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        address: formData.address,
                        nationality: formData.nationality,
                        phone: formData.phone,
                        
                        // CRITICAL fields for Cloud Functions
                        bookingId: bookingId,
                        userId: user.uid,
                        selectedLanguage: language, // IMPORTANTE: lingua per le istruzioni
                        submittedAt: window.Timestamp.now()
                    };

                    console.log('üíæ Salvataggio dati:', guestDataToSave);

                    const docRef = await window.addDoc(
                        window.collection(window.firebaseDb, 'guestData'), 
                        guestDataToSave
                    );

                    console.log('‚úÖ Documento creato con ID:', docRef.id);

                    // Update booking status
                    await window.updateDoc(window.doc(window.firebaseDb, 'bookings', bookingId), {
                        status: 'completed',
                        completedAt: window.Timestamp.now()
                    });

                    console.log('‚úÖ Booking aggiornato a completed');
                    console.log('üìß Ora le Cloud Functions dovrebbero inviare le email...');

                    setSubmitted(true);
                    alert(t.success + '\n\nControlla la tua email: ' + formData.email);
                } catch (error) {
                    console.error('‚ùå Errore durante l\'invio:', error);
                    console.error('Dettagli errore:', error.message);
                    alert(t.error + ': ' + error.message);
                } finally {
                    setSubmitting(false);
                }
            };

            const handleLogin = async () => {
                try {
                    const provider = new window.GoogleAuthProvider();
                    await window.signInWithPopup(window.firebaseAuth, provider);
                } catch (error) {
                    console.error('Login error:', error);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-2xl gradient-bg text-white px-8 py-4 rounded-2xl shadow-xl">
                            {t.loading}
                        </div>
                    </div>
                );
            }

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <div className="gradient-bg text-white rounded-xl p-6 mb-6 text-center">
                                <h2 className="text-2xl font-bold">üîê Login Richiesto</h2>
                            </div>
                            <p className="text-gray-600 mb-6 text-center">
                                Effettua il login per compilare i dati di check-in
                            </p>
                            <button
                                onClick={handleLogin}
                                className="w-full gradient-blue text-white py-4 rounded-xl hover:shadow-lg transition-all font-semibold"
                            >
                                üîë {t.login}
                            </button>
                        </div>
                    </div>
                );
            }

            if (!booking) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
                            <div className="text-6xl mb-4">‚ùå</div>
                            <h2 className="text-2xl font-bold text-red-600">{t.bookingNotFound}</h2>
                        </div>
                    </div>
                );
            }

            if (submitted) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                            <div className="gradient-green text-white rounded-xl p-8 mb-6">
                                <div className="text-6xl mb-4">‚úÖ</div>
                                <h2 className="text-3xl font-bold">{t.success}</h2>
                            </div>
                            <p className="text-gray-600 text-lg mb-4">
                                Grazie! Riceverai a breve un'email con le istruzioni di check-in.
                            </p>
                            <div className="bg-blue-50 p-4 rounded-lg">
                                <p className="text-sm text-gray-700">
                                    üìß Email: <strong>{formData.email}</strong><br/>
                                    üåç Lingua: <strong>{languages.find(l => l.code === language)?.name}</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 py-8">
                    <div className="max-w-4xl mx-auto">
                        {/* Header colorato */}
                        <div className="gradient-bg text-white rounded-2xl shadow-xl p-8 mb-6">
                            <h1 className="text-3xl font-bold mb-4">üìù {t.guestForm}</h1>
                            <div className="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                                <div className="grid md:grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <div className="opacity-75">Struttura</div>
                                        <div className="font-bold text-lg">{booking.propertyName}</div>
                                    </div>
                                    <div>
                                        <div className="opacity-75">{t.checkIn}</div>
                                        <div className="font-bold text-lg">{booking.checkIn}</div>
                                    </div>
                                    <div>
                                        <div className="opacity-75">{t.checkOut}</div>
                                        <div className="font-bold text-lg">{booking.checkOut}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Form */}
                        <div className="bg-white rounded-2xl shadow-xl p-8">
                            {/* UNICO Language Selector - controlla sia la lingua UI che quella delle istruzioni */}
                            <div className="mb-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border-2 border-purple-200">
                                <LanguageSelector 
                                    currentLang={language} 
                                    onLanguageChange={onLanguageChange}
                                    showLabel={true}
                                    t={t}
                                />
                                <p className="text-xs text-gray-600 mt-2 text-center">
                                    {t.emailWillReceive}
                                </p>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-8">
                                {/* Document Data */}
                                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl">
                                    <h3 className="text-xl font-bold mb-4 text-blue-700">üõÇ {t.documentData}</h3>
                                    <div className="grid md:grid-cols-2 gap-4">
                                        <div className="md:col-span-2">
                                            <label className="block text-sm font-bold mb-2">{t.documentNumber}</label>
                                            <input
                                                type="text"
                                                value={formData.documentNumber}
                                                onChange={(e) => setFormData({...formData, documentNumber: e.target.value})}
                                                className={`w-full border-2 rounded-lg px-4 py-3 ${errors.documentNumber ? 'border-red-500' : 'border-gray-200'} focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all`}
                                            />
                                            {errors.documentNumber && <p className="text-red-500 text-sm mt-1">{errors.documentNumber}</p>}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">{t.issueDate}</label>
                                            <input
                                                type="date"
                                                value={formData.issueDate}
                                                onChange={(e) => setFormData({...formData, issueDate: e.target.value})}
                                                className={`w-full border-2 rounded-lg px-4 py-3 ${errors.issueDate ? 'border-red-500' : 'border-gray-200'} focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all`}
                                            />
                                            {errors.issueDate && <p className="text-red-500 text-sm mt-1">{errors.issueDate}</p>}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">{t.expiryDate}</label>
                                            <input
                                                type="date"
                                                value={formData.expiryDate}
                                                onChange={(e) => setFormData({...formData, expiryDate: e.target.value})}
                                                className={`w-full border-2 rounded-lg px-4 py-3 ${errors.expiryDate ? 'border-red-500' : 'border-gray-200'} focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all`}
                                            />
                                            {errors.expiryDate && <p className="text-red-500 text-sm mt-1">{errors.expiryDate}</p>}
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-sm font-bold mb-2">{t.issuePlace}</label>
                                            <input
                                                type="text"
                                                value={formData.issuePlace}
                                                onChange={(e) => setFormData({...formData, issuePlace: e.target.value})}
                                                className={`w-full border-2 rounded-lg px-4 py-3 ${errors.issuePlace ? 'border-red-500' : 'border-gray-200'} focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all`}
                                            />
                                            {errors.issuePlace && <p className="text-red-500 text-sm mt-1">{errors.issuePlace}</p>}
                                        </div>
                                    </div>
                                </div>

                                {/* Personal Data */}
                                <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl">
                                    <h3 className="text-xl font-bold mb-4 text-purple-700">üë§ {t.personalData}</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">üìß Email</label>
                                            <input
                                                type="email"
                                                value={formData.email}
                                                onChange={(e) => setFormData({...formData, email: e.target.value})}
                                                placeholder="mario.rossi@example.com"
                                                className={`w-full border-2 rounded-lg px-4 py-3 ${errors.email ? 'border-red-500' : 'border-gray-200'} focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all`}
                                            />
                                            {errors.email && <p className="text-red-500 text-sm mt-1">{errors.email}</p>}
                                            <p className="text-xs text-gray-500 mt-1">üì¨ {t.emailWillReceive}</p>
                                        </div>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-bold mb-2">{t.firstName}</label>
                                                <input
                                                    type="text"
                                                    value={formData.firstName}
                                                    onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                                    className={`w-full border-2 rounded-lg px-4 py-3 ${errors.firstName ? 'border-red-500' : 'border-gray-200'} focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all`}
                                                />
                                                {errors.firstName && <p className="text-red-500 text-sm mt-1">{errors.firstName}</p>}
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold mb-2">{t.lastName}</label>
                                                <input
                                                    type="text"
                                                    value={formData.lastName}
                                                    onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                                    className={`w-full border-2 rounded-lg px-4 py-3 ${errors.lastName ? 'border-red-500' : 'border-gray-200'} focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all`}
                                                />
                                                {errors.lastName && <p className="text-red-500 text-sm mt-1">{errors.lastName}</p>}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">{t.address}</label>
                                            <input
                                                type="text"
                                                value={formData.address}
                                                onChange={(e) => setFormData({...formData, address: e.target.value})}
                                                className={`w-full border-2 rounded-lg px-4 py-3 ${errors.address ? 'border-red-500' : 'border-gray-200'} focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all`}
                                            />
                                            {errors.address && <p className="text-red-500 text-sm mt-1">{errors.address}</p>}
                                        </div>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-bold mb-2">{t.nationality}</label>
                                                <input
                                                    type="text"
                                                    value={formData.nationality}
                                                    onChange={(e) => setFormData({...formData, nationality: e.target.value})}
                                                    className={`w-full border-2 rounded-lg px-4 py-3 ${errors.nationality ? 'border-red-500' : 'border-gray-200'} focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all`}
                                                />
                                                {errors.nationality && <p className="text-red-500 text-sm mt-1">{errors.nationality}</p>}
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold mb-2">{t.phone}</label>
                                                <input
                                                    type="tel"
                                                    value={formData.phone}
                                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                                    className={`w-full border-2 rounded-lg px-4 py-3 ${errors.phone ? 'border-red-500' : 'border-gray-200'} focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all`}
                                                />
                                                {errors.phone && <p className="text-red-500 text-sm mt-1">{errors.phone}</p>}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button
                                    type="submit"
                                    disabled={submitting}
                                    className="w-full gradient-green text-white py-4 rounded-xl hover:shadow-lg transition-all disabled:opacity-50 font-bold text-lg"
                                >
                                    {submitting ? '‚è≥ ' + t.submitting : '‚úÖ ' + t.submit}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [language, setLanguage] = useState('it');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isAdmin, setIsAdmin] = useState(false);
            
            const t = translations[language];
            
            // Get booking ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('booking');

            useEffect(() => {
                const unsubscribe = window.onAuthStateChanged(window.firebaseAuth, (user) => {
                    setUser(user);
                    setLoading(false);
                    // If user is logged in and no booking ID, assume admin
                    if (user && !bookingId) {
                        setIsAdmin(true);
                    }
                });
                return () => unsubscribe();
            }, [bookingId]);

            const handleLogout = async () => {
                await window.signOut(window.firebaseAuth);
                setIsAdmin(false);
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-2xl gradient-bg text-white px-8 py-4 rounded-2xl shadow-xl animate-pulse">
                            {t.loading}
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    {/* Language selector UNICO - mostrato solo per guest form e login */}
                    {!isAdmin && (
                        <div className="bg-white shadow-sm py-3">
                            <div className="max-w-7xl mx-auto px-4">
                                <LanguageSelector currentLang={language} onLanguageChange={setLanguage} t={t} />
                            </div>
                        </div>
                    )}

                    {/* Routing logic */}
                    {bookingId ? (
                        // Guest form flow - passa language e onLanguageChange
                        <GuestForm 
                            t={t} 
                            bookingId={bookingId} 
                            language={language} 
                            onLanguageChange={setLanguage} 
                        />
                    ) : user && isAdmin ? (
                        // Admin dashboard
                        <AdminDashboard t={t} user={user} onLogout={handleLogout} />
                    ) : (
                        // Login page
                        <LoginPage t={t} />
                    )}
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
